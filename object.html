<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title></title>
  <meta name="description" content="">
  <meta name="author" content="">
<style>
div#testing { 
        position: absolute;
        z-index: 91;
        overflow: auto;
        border: 0;
        width: 100px;
        height: 100px;
    }
</style>

</head>

<body id="_main">

<script>
var t = "<div style='text-align:center;color:red;'><p style='text-align:center;'>Lorem ipsum dolor sit amet, sumo legimus sed id, eu mea legere vivendum. Vis lobortis repudiare scribentur id, diceret sanctus omnesque ei eum. Ut inani euripidis definiebas duo. Mei et aliquid quaerendum interpretaris. Pro te alii facete, pro prima percipit ei. Vel ne convenire torquatos, mel eu tantas repudiare sadipscing.</p> </div>" +
"<p> Sed inani feugait scribentur ne, possit epicurei te vel, nonumes elaboraret te pro. Quo ut summo oratio efficiantur, ad mei nulla iusto pericula. Congue tractatos te his, et enim sint ius, iudico corrumpit omittantur qui cu. Usu ne animal nominati contentiones. Ne eos illum voluptatibus, meis aliquam tibique sit id. No per petentium imperdiet expetendis, te cibo autem incorrupte vix. </p>" +
"<p>Ut <i>pro luptatum gloriatur <b>intellegebat. Ne pro dicunt audiam, no dolore</i> indoctum usu. Debet</b> animal mentitum ad est, no alienum petentium adipiscing vel. Cu integre consequat quo, primis iudicabit mel id. Ius ferri ludus mentitum ad, duo ceteros appellantur ei, et usu oratio definitionem. Quo ut alia solum, dicant eripuit quo in.</p> " +
"<p>Noluisse deserunt ut has, convenire consequat an eos. Illum honestatis nam ex, blandit lucilius laboramus ex per. Vix pertinax concludaturque vituperatoribus te, mei ad velit invidunt nominati. Singulis referrentur in qui, ius te malis feugiat, ex ius nulla alterum insolens. Pro veniam eruditi indoctum ut, volumus disputando ut nam. Modus reprehendunt vis an, agam fugit iisque ex pri, in ludus menandri vim.</p> " +
"<p>Pro ei aliquam concludaturque. Sea everti aeterno intellegam cu, no labore officiis cum. Veniam singulis gubergren ea his, ius in nostrud voluptatibus. Elitr inciderint vis cu, ea dicam erroribus vix, vim vocent tacimates suscipiantur cu. Quem dicunt regione ad nam.</p>" +
"<p>Mea id cetero persequeris. Eos et vitae quodsi molestiae, vel alia sententiae accommodare ne, deserunt praesent ea vix. Sed eu sale vulputate, ne altera adolescens cum. Ex sit luptatum incorrupte, brute error invidunt eum eu, bonorum accumsan vulputate ad eos. Id harum alterum appellantur vel, his minimum persequeris ne.</p>" +
"<p>Graeco dignissim an has. Sapientem philosophia vel et, integre constituam cu pro. Mea augue legimus electram in, dicta paulo eum in. Dicam debitis nostrum per ad, eam dicta splendide id, quod timeam liberavisse ei nam. Has ad dicant molestie disputationi. Ne graecis omittam scribentur duo.</p>" +
"<p>Quo rebum consectetuer ne. Mel elitr facete in, nam ex augue vocibus, labore legimus corrumpit vel no. Et cetero aperiam urbanitas duo, quo at quaeque ceteros. At vix simul choro, sea ubique volumus eligendi cu. Mei ad percipit nominati efficiantur, vitae democritum ut has, eam et dolore delenit expetenda. Brute lorem id vix, vis eius clita nostrum an.</p>" +
"<p>No cum tritani facilisi facilisis, eum brute feugait ex, his ad assueverit conclusionemque vituperatoribus. His postea graeco in, vim mundi dolor solet an. Tantas euismod evertitur id mel, his adhuc malis mandamus in. Possit impetus invidunt et pri, quo ne alterum sanctus, at eam mucius option equidem.</p>" +
"<p>An cum fastidii scripserit, ne vix ferri iracundia, sit et meis inani. Aperiam delenit ei sea, ius cibo veniam no, per vero impedit ex. Eum id iudico facilis, enim voluptua ut qui. Melius latine mei te, te summo affert consectetuer has. Exerci fastidii conceptam cu mel, expetenda disputando ea nec. Ex vim ridens senserit, id docendi reformidans sit, id est eruditi reprehendunt.</p>";


var Main = document.getElementById("_main");

var TextFrame = function(name, layer) {
    var framename = name;
    var css = document.createElement('style');
    var size = {
        ratio_min: 0,
        ratio_max: 1,
        dx_min: 100,
        dy_min: 100            
    }
    var margin = {
        top: 1,
        left: 100,
        right: 100,
        bottom: 100,
        topR: 0,
        leftR: 0,
        rightR: 0,
        bottomR: 0
    }
    var padding = {
        top: 10,
        left: 20,
        right: 20,
        bottom: 10,
        topR: 30,
        leftR: 50,
        rightR: 50,
        bottomR: 30
    }
    var visible = false;
    var textBottom;
    var text = "";
    var w_start = new Array();
    var w_end = new Array();
    var w_format = new Array();
    var w_length = 0;
    var words_in_page = 0;
    var w_offset;
    var w_nextpage;



    this.render = function () {
        if(!visible) return;

        var scrDX = document.documentElement.clientWidth;
        var scrDY = document.documentElement.clientHeight;
        var x, y, dx, dy;
        var x0, y0, dx0, dy0;

        dx0 = scrDX - margin.left - margin.right -
            Math.round(margin.rightR * scrDX / 1000) -
            Math.round(margin.leftR * scrDX / 1000);
        dy0 = scrDY - margin.top - margin.bottom -
            Math.round(margin.topR * scrDY / 1000) -
            Math.round(margin.bottomR * scrDY / 1000);
        if(dx0 < size.dx_min) dx0 = size.dx_min;
        if(dy0 < size.dy_min) dy0 = size.dy_min;

        x0 = (scrDX - dx0) >> 1;
        y0 = margin.top;

        dx = dx0 - padding.left - padding.right -
            Math.round(padding.rightR * dx0 / 1000) -
            Math.round(padding.leftR * dx0 / 1000);
        dy = dy0 - padding.top - padding.bottom -
            Math.round(padding.topR * dy0 / 1000) -
            Math.round(padding.bottomR * dy0 / 1000);

        x = x0 + ((dx0 - dx) >> 1);
        y = y0 + ((dy0 - dy) >> 1);
        textBottom = y + dy;

        Outer.style.left = x0 + "px";
        Outer.style.top = y0 + "px";
        Outer.style.width = dx0 + "px";
        Outer.style.height = dy0 + "px";
        Inner.style.left = x + "px";
        Inner.style.top = y + "px";
        Inner.style.width = dx + "px";
        Inner.style.height = dy + "px";

        renderText();
    }

    this.show = function () {
        if(visible) return;
        Inner.style.display = "block";
        Outer.style.display = "block";
        visible = true;
        this.render();
    }

    this.hide = function () {
        if(!visible) return;
        Inner.style.display = "none";
        Outer.style.display = "none";
        visible = false;
    }

    this.setText = function (inputtext) {
        text = inputtext;

        var i = 0, n = 0;
        var space = true, tag = false;
        var opentags = 0, formatStart = 0;
        
        for(i = 0; i < text.length; i++) {
            var c = text.charAt(i);
            
            if(c == '<') {
                i++; c = text.charAt(i);
                
                if(c == '/') {
                    if(!space) {
                        if(text.charAt(i + 1) == 'p' &&
                            text.charAt(i + 2) == '>') {
                                w_end[n] = i - 1;
                                space = true;
                                n++;
                        }
                    }   // </p> means end of word
                    opentags--;
                }   // closing tag
                else {
                    if(opentags == 0) {
                        formatStart = i - 1;
                    }
                    opentags++;
                }   // opening tag
                
                do {
                    i++; c = text.charAt(i);
                    if(c == '/')
                        if(text.charAt(i + 1) == '>')
                            opentags--;
                } while(c != '>');
            }   // tag processing
            
            else {
                if(c == ' ' || c == 'â€”' || c == '-' || c == '\r' || c == '\n') {
                    if(!space) {
                        w_end[n] = i;
                        space = true;
                        n++;
                    }
                }
                else {
                    if(space) {
                        w_start[n] = i;
                        w_format[n] = formatStart;
                        space = false;
                    }
                }
            }   // not a tag, process words and spaces
        }
        w_length = n;
        
    }

    function renderText() {
        var step = 256, rect;
        if(words_in_page > 0) step = words_in_page;

        var first = w_offset, last = w_offset + step;
        while(isWordVisible(last)) {
            first = last; last += step;
        }
        if(last > w_length) last = w_length;
        while(last - first > 1) {
            step = (last - first) >> 1;
            var i = first + step;
            if(isWordVisible(i))
                first = i;
            else last = i;
        }
        trimTextBy(last);
        w_nextpage = last;
        words_in_page = w_nextpage - w_offset;
    }

    function isWordVisible(word) {
        console.log("Word:" + word + " w_length:" + w_length + "\n");
        if(word >= w_length) return false;
        trimTextBy(word);
        if(document.getElementById("_hide").
            getBoundingClientRect().bottom < textBottom) return true;
        return false;
    }
 
    function trimTextBy(word) {
        var txt = "";
        if(w_format[w_offset] < w_start[w_offset])
            txt += "<a style='display:none;'>" +
            text.substring(w_format[w_offset],w_start[w_offset]) + "</a>";
        if(word < w_length) {
            txt += text.substring(w_start[w_offset], w_start[word]) +
                "<a id='_hide' style='visibility:hidden;'>" +
                text.substring(w_start[word], w_end[word]) +
                "</a>";
        }
        else txt += text.substring(w_start[w_offset]);
        
        Inner.innerHTML = txt;
    }
  


//------------------initialization
    Main.innerHTML += "<div id='" + framename + "' style='position: absolute; z-index: " +
        (layer + 1) + "; overflow: visible; border: 0; display: none;'></div>" + "\n";
    Main.innerHTML += "<div id='" + framename + "0' style='position: absolute; z-index: " +
        layer + "; border: 1px solid; display: none;'></div>" + "\n";
    var Inner = document.getElementById(framename);
    var Outer = document.getElementById(framename + "0");

    window.addEventListener("resize", this.render);


    return {
        name: framename,
        render: this.render,
        show: this.show,
        hide: this.hide,
        setText: this.setText
    }
}



var testing = new TextFrame("testing", 90);
testing.setText(t);
testing.show();

    
    
</script>
    
</body>
</html>